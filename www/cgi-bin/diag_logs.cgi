#!/bin/sh

# Version: 3.10 2017-01-06
#	Improved display of pcp_boot.log. GE.

# Version: 0.01 2016-04-23
#	Original. GE.

. pcp-functions
pcp_variables
. $CONFIGCFG

pcp_html_head "Show pCP log files" "GE"

pcp_banner
pcp_diagnostics
pcp_running_script
pcp_httpd_query_string

#========================================================================================
# piCorePlayer log files should be located in the $LOGDIR directory (default /var/log).
#
# Log filenames need to be formatted correctly:
#  - start with "pcp_"
#  - end in ".log"
#
# i.e. pcp_diagnostics.log
#
# Note:
#  LMS log filenames do not follow this standard and are located in /var/log/slimserver.
#----------------------------------------------------------------------------------------
PCPLOGS=$(ls "$LOGDIR" | grep pcp_ | grep log$)
[ x"" != x"$PCPLOGS" ] && LOGS=$PCPLOGS

LMSLOGS=$(cd "${LOGDIR}"; ls slimserver/*.log)
[ x"" != x"$LMSLOGS" ] && LOGS=${LOGS}" "$LMSLOGS
[ x"" = x"$LOGS" ] && FIRST="No log files found." || FIRST="All"

#========================================================================================
# Selection form
#----------------------------------------------------------------------------------------
echo '<table class="bggrey">'
echo '  <tr>'
echo '    <td>'
echo '      <div class="row">'
echo '        <fieldset>'
echo '          <legend>Log file operations</legend>'
echo '          <table class="bggrey percent100">'
echo '            <form name="log" action="'$0'" method="get">'
#----------------------------------------------------------------------------------------
pcp_incr_id
pcp_start_row_shade
echo '            <tr class="'$ROWSHADE'">'
echo '              <td class="column300">'
echo '                <select class="large22" name="SELECTION">'
echo '                  <option value="'$FIRST'">'$FIRST'</option>'

	                    for LOG in $LOGS
	                    do
	                        echo '                  <option value="'$LOG'">'$LOG'</option>'
	                    done

echo '                </select>'
echo '              </td>'
echo '              <td>'
echo '                <p>Select log file(s) to show&nbsp;&nbsp;'
echo '                  <a id="'$ID'a" class="moreless" href=# onclick="return more('\'''$ID''\'')">more></a>'
echo '                </p>'
echo '                <div id="'$ID'" class="less">'
echo '                  <p>Log files are generated by visiting the various diagnostics pages.</p>'
echo '                  <p>Log files prefixed with "slimserver" are LMS log files (LMS needs to be on).</p>'
echo '                  <p><b>Note:</b> Log files are temporary, they are not preserved after a reboot.</p>'
echo '                </div>'
echo '              </td>'

if [ "$FIRST" = "All" ]; then
	pcp_toggle_row_shade
	echo '              <tr class="'$ROWSHADE'">'
	echo '                <td>'
	echo '                  <input type="submit" name="ACTION" value="Show">'
	echo '                </td>'
	echo '              </tr>'
fi
#----------------------------------------------------------------------------------------
echo '          </table>'
echo '        </fieldset>'
echo '      </div>'
echo '    </td>'
echo '  </tr>'
echo '</table>'
#----------------------------------------------------------------------------------------

#------------------------------------------Log text area---------------------------------
pcp_log_show() {
	echo '<table class="bggrey">'
	echo '  <tr>'
	echo '    <td>'
	echo '      <div class="row">'
	echo '        <fieldset>'
	echo '          <legend>Show log file(s)</legend>'
	echo '          <table class="bggrey percent100">'

	if [ "$SELECTION" = "All" ]; then
		for LOG in $LOGS
		do
			echo '            <tr>'
			echo '              <td>'
			                      if [ "$LOG" = "pcp_boot.log" ]; then
			                          pcp_textarea_inform "$LOG" 'cat ${LOGDIR}/$LOG | sed "s/\[[01]\;3[0-9]m//g"' 250
			                      else
			                          pcp_textarea_inform "$LOG" 'cat ${LOGDIR}/$LOG' 250
			                      fi
			echo '              </td>'
			echo '            </tr>'
		done
	else
		echo '            <tr>'
		echo '              <td>'
		                      if [ "$SELECTION" = "pcp_boot.log" ]; then
		                          pcp_textarea_inform "$SELECTION" 'cat ${LOGDIR}/$SELECTION | sed "s/\[[01]\;3[0-9]m//g"' 250
		                      else
		                          pcp_textarea_inform "$SELECTION" 'cat ${LOGDIR}/$SELECTION' 250
		                      fi
		echo '              </td>'
		echo '            </tr>'
	fi

	echo '          </table>'
	echo '        </fieldset>'
	echo '      </div>'
	echo '    </td>'
	echo '  </tr>'
	echo '</table>'
}
[ "$ACTION" = "Show" ] && pcp_log_show
#----------------------------------------------------------------------------------------

pcp_footer
pcp_copyright

echo '</body>'
echo '</html>'