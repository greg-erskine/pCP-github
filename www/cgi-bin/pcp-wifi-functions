#!/bin/sh

# Version: 4.0.0 2018-04-22

#========================================================================================
# Load wifi extensions.
#----------------------------------------------------------------------------------------
pcp_message() {
#	$1 = type: OK|INFO|ERROR|DEBUG
#	$2 = message
#	$3 = format: colour|text|html

	MESSAGE=$2
	case $1 in
		OK|ok)
			case $3 in
				col*|COL*) echo "${GREEN}${MESSAGE}${NORMAL}" ;;
				text|TEXT) echo '[ OK ] '${MESSAGE} ;;
				html|HTML) echo '<p class="ok">[ OK ] '${MESSAGE}'</p>' ;;
			esac
		;;
		INFO|info)
			case $3 in
				col*|COL*) echo "${YELLOW}${MESSAGE}${NORMAL}" ;;
				text|TEXT) echo '[ INFO ] '${MESSAGE} ;;
				html|HTML) echo '<p class="info">[ INFO ] '${MESSAGE}'</p>' ;;
			esac
		;;
		ERROR|error)
			case $3 in
				col*|COL*) echo "${RED}${MESSAGE}${NORMAL}" ;;
				text|TEXT) echo '[ ERROR ] '${MESSAGE} ;;
				html|HTML) echo '<p class="error">[ ERROR ] '${MESSAGE}'</p>' ;;
			esac
		;;
		DEBUG|debug)
			case $3 in
				col*|COL*) echo "${ORANGE}${MESSAGE}${NORMAL}" ;;
				text|TEXT) echo '[ DEBUG ] '${MESSAGE} ;;
				html|HTML) echo '<p class="debug">[ DEBUG ] '${MESSAGE}'</p>' ;;
			esac
		;;
	esac
}

pcp_wifi_load_extn() {
	# $1 - extension
	# $2 - description
	# $3 - colour|text|html

	sudo -u tc pcp-load -i $1 >/dev/null 2>&1
	if [ $? -eq 0 ]; then
		pcp_message OK "$2 loaded." "$3"
	else
		pcp_message ERROR "$2 load error." "$3"
	fi
	sudo sed -i '/'$1'/d' $ONBOOTLST
	sudo echo $1 >> $ONBOOTLST
}

#========================================================================================
# Load wifi extensions.
#----------------------------------------------------------------------------------------
pcp_wifi_load_wifi_extns() {
	# $1 - colour|text|html

	pcp_message INFO "Loading wifi extensions..." "$1"

	pcp_wifi_load_extn "wireless_tools.tcz" "Wireless tools" "$1"
	pcp_wifi_load_extn "wpa_supplicant.tcz" "WPA supplicant" "$1"

	pcp_message OK "Done." "$1"
}

#========================================================================================
# Load wifi firmware extensions.
#----------------------------------------------------------------------------------------
pcp_wifi_load_wifi_firmware_extns() {
	# $1 - format: colour|text|html

	pcp_message INFO "Loading wifi firmware extensions..." "$1"

	pcp_wifi_load_extn "firmware-atheros.tcz" "Atheros firmware" "$1"
	pcp_wifi_load_extn "firmware-brcmwifi.tcz" "Broadcom USB firmware" "$1"
	pcp_wifi_load_extn "firmware-ralinkwifi.tcz" "Ralink firmware" "$1"
	pcp_wifi_load_extn "firmware-rtlwifi.tcz" "Realtek firmware" "$1"
	pcp_wifi_load_extn "firmware-rpi3-wireless.tcz" "RPi Broadcom firmware" "$1"

	pcp_message OK "Done." "$1"
}

#========================================================================================
# Read wifi settings from current wpa_supplicant.conf
#----------------------------------------------------------------------------------------
pcp_wifi_read_wpa_supplicant() {
	if [ -f $WPASUPPLICANTCONF ]; then
		pcp_message INFO "Reading from $WPASUPPLICANTCONF..." "$1"

		unset WPA_SSID WPA_PASSWORD WPA_PW WPA_PSK WPA_PASSPHRASE KEY_MGMT WPA_ENCRYPTION WPA_HIDDENSSID

		for i in $(cat $WPASUPPLICANTCONF); do
			case $i in
				*=*)
					case $i in
						ssid=*)
							WPA_SSID=${i#*=}
							WPA_SSID=$(echo $WPA_SSID | sed -e 's/^\"\(.*\)\"$/\1/')
						;;
						psk=\"*)
							WPA_PASSWORD=${i#*=}
							WPA_PASSWORD=$(echo $WPA_PASSWORD | sed -e 's/^\"\(.*\)\"$/\1/')
							WPA_PW=TRUE
						;;
						psk=*)
							WPA_PSK=${i#*=}
							[ $WPA_PW ] || WPA_PASSPHRASE=$WPA_PSK
						;;
						key_mgmt=*)
							KEY_MGMT=${i#*=}
							WPA_ENCRYPTION=WPA-PSK
							[ "$KEY_MGMT" = "NONE" ] && WPA_ENCRYPTION=OPEN
							[ "$KEY_MGMT" = "NONE" ] && [ $WPA_PW ] && WPA_ENCRYPTION=WEP
						;;
						scan_ssid=*)
							WPA_HIDDENSSID=${i#*=}
							[ x"" = x"$WPA_HIDDENSSID" ] && WPA_HIDDENSSID=0
						;;
					esac
			esac
		done
		[ "$WPA_ENCRYPTION" != "WPA-PSK" ] && WPA_PASSPHRASE=""
	else
		pcp_message ERROR "$WPASUPPLICANTCONF not found." "text"
	fi
}

#========================================================================================
# Read wifi settings from newconfig.cfg <=== NOT USED YET. NOT TESTED.
#----------------------------------------------------------------------------------------
pcp_wifi_read_newconfig() {
	unset WPA_SSID WPA_PASSWORD WPA_PW KEY_MGMT WPA_ENCRYPTION

	for i in $(cat $NEWCONFIGCFG); do
		case $i in
			*=*)
				case $i in
					SSID=*)
						WPA_SSID=${i#*=}
						WPA_SSID=$(echo $WPA_SSID | sed -e 's/^\"\(.*\)\"$/\1/')
					;;
					PASSWORD=*)
						WPA_PASSWORD=${i#*=}
						WPA_PASSWORD=$(echo $WPA_PASSWORD | sed -e 's/^\"\(.*\)\"$/\1/')
						WPA_PW=TRUE
					;;
					ENCRYPTION=*)
						KEY_MGMT=${i#*=}
						KEY_MGMT=$(echo $KEY_MGMT | sed -e 's/^\"\(.*\)\"$/\1/')
						[ "$KEY_MGMT" = "WPA" ] && WPA_ENCRYPTION=WPA-PSK
						[ "$KEY_MGMT" = "WEP" ] && WPA_ENCRYPTION=WEP
						[ "$KEY_MGMT" = "NONE" ] && WPA_ENCRYPTION=NONE
					;;
				esac
		esac
	done
}

#========================================================================================
# Write wifi settings to wpa_supplicant.conf file.
#----------------------------------------------------------------------------------------
pcp_wifi_write_wpa_supplicant() {
	pcp_message INFO "Writing to $WPASUPPLICANTCONF..." "$1"

	echo '# Generated by piCorePlayer' > $WPASUPPLICANTCONF
	echo 'ctrl_interface=/var/run/wpa_supplicant' >> $WPASUPPLICANTCONF
	echo 'ctrl_interface_group=staff' >> $WPASUPPLICANTCONF
	echo 'update_config=1' >> $WPASUPPLICANTCONF
	echo '' >> $WPASUPPLICANTCONF
	echo 'network={' >> $WPASUPPLICANTCONF

	echo '	ssid="'$WPA_SSID'"' >> $WPASUPPLICANTCONF
	if [ "$WPA_ENCRYPTION" = "WPA-PSK" ]; then
		if [ x"" = x"$WPA_PASSPHRASE" ]; then
			echo '	psk="'$WPA_PASSWORD'"' >> $WPASUPPLICANTCONF
		else
			echo '	psk='$WPA_PASSPHRASE >> $WPASUPPLICANTCONF
		fi
	fi
	[ "$WPA_ENCRYPTION" = "WEP"     ] && echo '	psk="'$WPA_PASSWORD'"' >> $WPASUPPLICANTCONF
	[ "$WPA_ENCRYPTION" = "WPA-PSK" ] && echo '	key_mgmt=WPA-PSK' >> $WPASUPPLICANTCONF
	[ "$WPA_ENCRYPTION" = "WEP"     ] && echo '	key_mgmt=NONE' >> $WPASUPPLICANTCONF
	[ "$WPA_ENCRYPTION" = "OPEN"    ] && echo '	key_mgmt=NONE' >> $WPASUPPLICANTCONF
	echo '	auth_alg=OPEN' >> $WPASUPPLICANTCONF
	[ $WPA_HIDDENSSID -eq 1 ] && echo '	scan_ssid='$WPA_HIDDENSSID >> $WPASUPPLICANTCONF

	echo '}' >> $WPASUPPLICANTCONF
}

#========================================================================================
# Check all wifi extensions are installed.
#----------------------------------------------------------------------------------------
pcp_wifi_extension_installed() {
	# $1 - format: colour|text|html
	# $2 - extension

	if [ $(pcp_extn_is_installed $2) -eq 0 ]; then
		pcp_message OK "$2 installed." "$1"
	else
		pcp_message ERROR "$2 not installed." "$1"
	fi
}

pcp_wifi_all_extensions_installed() {
	EXTN_LIST="wireless_tools wpa_supplicant XXXx
	firmware-atheros firmware-brcmwifi firmware-ralinkwifi firmware-rtlwifi firmware-rpi3-wireless"

	for i in $EXTN_LIST; do
		pcp_wifi_extension_installed "html" $i
	done
}

#========================================================================================
# Generate WPA passphrase from SSID and password.
#----------------------------------------------------------------------------------------
pcp_wifi_generate_passphrase() {
	pcp_debug_variables "text" WPA_PASSWORD WPA_ENCRYPTION WPA_PASSPHRASE

	[ $DEBUG -eq 1 ] && pcp_message DEBUG "Generating new passphrase..." "$1"
	if [ "$WPA_PASSWORD" != "" ] && [ "$WPA_ENCRYPTION" = "WPA-PSK" ]; then
		WPA_PASSPHRASE="$(wpa_passphrase $WPA_SSID $WPA_PASSWORD)"
		if [ $? -eq 0 ]; then
			WPA_PASSPHRASE=$(echo $WPA_PASSPHRASE | cut -d = -f 5 | cut -b 1-64)
			WPA_PASSWORD=""
		fi
	else
		if [ "$WPA_PASSPHRASE" = "" ]; then
			WPA_PASSPHRASE="[ ERROR ] Password has not been set."
		fi
	fi

	pcp_debug_variables "text" WPA_PASSWORD WPA_ENCRYPTION WPA_PASSPHRASE
}

#========================================================================================
# wifi extensions and dependencies.
#----------------------------------------------------------------------------------------
#cat piCorePlayer.dep
# pcp.tcz
# firmware-atheros.tcz
# firmware-brcmwifi.tcz
# firmware-rpi3-wireless.tcz
# firmware-ralinkwifi.tcz
# firmware-rtlwifi.tcz
# wifi.tcz
#
# piCorePlayer.dep
# |
# |--pcp.tcz.dep
# |   |
# |   |--pcp-base.tcz
# |   |--alsa.tcz.dep
# |   |   |
# |   |   \--libasound.tcz.dep
# |   |       |
# |   |       \alsa-modules-KERNEL.tcz.
# |   |
# |   |--alsa-utils.tcz.dep
# |   |   |
# |   |   |--libasound.tcz->
# |   |   \--ncurses.tcz.
# |   |
# |   |--busybox-httpd.tcz
# |   |--openssh.tcz.dep
# |   |   |
# |   |   |--libedit.tcz.dep
# |   |   |   |
# |   |   |   \--ncurses.tcz.
# |   |   |
# |   |   \--openssl.tcz.dep
# |   |       |
# |   |       \--ca-certificates.tcz.
# |   |
# |   |--dialog.tcz.dep
# |   |   |
# |   |   \--ncurses.tcz.
# |   |
# |   \--pcp-squeezelite.tcz.dep
# |       |
# |       |--pcp-libmpg123.tcz.dep
# |       |   |
# |       |   \--libasound.tcz.dep
# |       |       |
# |       |       \--alsa-modules-KERNEL.tcz.
# |       |
# |       |--pcp-libfaad2.tcz
# |       |--pcp-libsoxr.tcz
# |       |--pcp-libmad.tcz
# |       |--pcp-libvorbis.tcz
# |       |   |
# |       |   \--pcp-libogg.tcz.
# |       |
# |       |--pcp-libflac.tcz
# |       |   |
# |       |   \--pcp-libogg.tcz.
# |       |
# |       |--libasound.tcz
# |       |   |
# |       |   \--alsa-modules-KERNEL.tcz.
# |       |
# |       \--wiringpi.tcz.
# |
# |--firmware-atheros.tcz
# |--firmware-brcmwifi.tcz
# |--firmware-ralinkwifi.tcz
# |--firmware-rtlwifi.tcz
# |--firmware-rpi3-wireless.tcz
# |
# \--wifi.tcz.dep
#     |
#     |--wireless_tools.tcz.dep
#     |   |
#     |   |--libiw.tcz
#     |   \--wireless-KERNEL.tcz
#     |
#     \--wpa_supplicant.tcz.dep
#         |
#         |--libnl.tcz
#         |--openssl.tcz.dep
#         |   |
#         |   \--ca-certificates.tcz.
#         |
#         \--readline.tcz
#             |
#             \--ncurses.tcz.
